**Date** : 2025-08-02
**Link** :   https://tryhackme.com/room/zeekbro
**Description** : Introduction to hands-on network monitoring and threat detection with Zeek (formerly Bro).

# Introduction

Zeek (formerly Bro) is an open-source and commercial network monitoring tool (traffic analyser).
[The official description;](https://docs.zeek.org/en/master/about.html) "Zeek (formerly Bro) is the world's leading platform for network security monitoring. Flexible, open-source, and powered by defenders." "Zeek is a passive, open-source network traffic analyser. Many operators use Zeek as a network security monitor (NSM) to support suspicious or malicious activity investigations. Zeek also supports a wide range of traffic analysis tasks beyond the security domain, including performance measurement and troubleshooting."


# Network Security Monitoring and Zeek

## Introduction to Network Monitoring Approaches

Network monitoring is a set of management actions to watch/continuously overview and optionally save the network traffic for further investigation.

## Network Monitoring

Network monitoring is highly focused on IT assets like uptime (availability), device health and connection quality (performance), and network traffic balance and management (configuration). Monitoring and visualising the network traffic, troubleshooting, and root cause analysis are also part of the Network Monitoring process.

## Network Security Monitoring

Monitoring network anomalies

## What is Zeek
Zeek (formerly Bro) is an open-source and commercial passive Network Monitoring tool (traffic analysis framework)

## Zeek vs Snort

While both are called IDS/NIDS, it is good to know the cons and pros of each tool and use them in a specific manner. While there are some overlapping functionalities, they have different purposes for usage.

|                     |                                                                                                                                                                                                                    |                                                                                                                                                         |
| ------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Tool**            | **Zeek**                                                                                                                                                                                                           | **Snort**                                                                                                                                               |
| **Capabilities**    | NSM and IDS framework. It is heavily focused on network analysis. It is more focused on specific threats to trigger alerts. The detection mechanism is focused on events.                                          | An IDS/IPS system. It is heavily focused on signatures to detect vulnerabilities. The detection mechanism is focused on signature patterns and packets. |
| **Cons**            | Hard to use.<br><br>The analysis is done out of the Zeek, manually or by automation.                                                                                                                               | Hard to detect complex threats.                                                                                                                         |
| **Pros**            | It provides in-depth traffic visibility.<br><br>Useful for threat hunting.<br><br>Ability to detect complex threats.<br><br>It has a scripting language and supports event correlation. <br><br>Easy to read logs. | Easy to write rules.<br><br>Cisco supported rules.<br><br>Community support.                                                                            |
| **Common Use Case** | Network monitoring.  <br>In-depth traffic investigation.  <br>Intrusion detecting in chained events.                                                                                                               | Intrusion detection and prevention.  <br>Stop known attacks/threats.                                                                                    |

## Zeek Architecture

![](https://tryhackme-images.s3.amazonaws.com/user-uploads/6131132af49360005df01ae3/room-content/07d58ecdaa53829df19be1ec47d2d666.png)


Zeek has two primary layers; "Event Engine" and "Policy Script Interpreter". The Event Engine layer is where the packets are processed; it is called the event core and is responsible for describing the event without focusing on event details. It is where the packages are divided into parts such as source and destination addresses, protocol identification, session analysis and file extraction.
The Policy Script Interpreter layer is where the semantic analysis is conducted. It is responsible for describing the event correlations by using Zeek scripts.

## Zeek Framework

**Available Frameworks**

| Logging   | Notice               | Input      | Configuration   | Intelligence   |
| --------- | -------------------- | ---------- | --------------- | -------------- |
| Cluster   | Broker Communication | Supervisor | GeoLocation     | File Analysis  |
| Signature | Summary              | NetControl | Packet Analysis | TLS Decryption |
You can read more on frameworks [**here**](https://docs.zeek.org/en/master/frameworks/index.html).

## Zeek Outputs

As mentioned before, Zeek provides 50+ log files under seven different categories, which are helpful in various areas such as traffic monitoring, intrusion detection, threat hunting and web analytics.
Once you run Zeek, it will automatically start investigating the traffic or the given pcap file and generate logs automatically. Once you process a pcap with Zeek, it will create the logs in the working directory. If you run the Zeek as a service, your logs will be located in the default log path. The default log path is: `/opt/zeek/logs/`

## Working with Zeek
![[Pasted image 20250803114456.png]]

|               |                                           |
| ------------- | ----------------------------------------- |
| **Parameter** | **Description**                           |
| **-r**        | Reading option, read/process a pcap file. |
| **-C**        | Ignoring checksum errors.                 |
| **-v**        | Version information.                      |
| **zeekctl**   | ZeekControl module.                       |

# Zeek Logs

Please refer to [Zeek's official documentation](https://docs.zeek.org/en/current/script-reference/log-files.html) and [Corelight log cheat sheet](https://corelight.com/about-zeek/zeek-data) for more information. Although there are multiple log files, some log files are updated daily, and some are updated in each session. Some of the most commonly used logs are explained in the given table.

## Zeek logs in a nutshell**

| Category             | Description                                                              | **Log Files**                                                                                                                                                                                                                                                                                                                      |
| -------------------- | ------------------------------------------------------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Network              | Network protocol logs.                                                   | _conn.log, dce_rpc.log, dhcp.log, dnp3.log, dns.log, ftp.log, http.log, irc.log, kerberos.log, modbus.log, modbus_register_change.log, mysql.log, ntlm.log, ntp.log, radius.log, rdp.log, rfb.log, sip.log, smb_cmd.log, smb_files.log, smb_mapping.log, smtp.log, snmp.log, socks.log, ssh.log, ssl.log, syslog.log, tunnel.log._ |
| Files                | File analysis result logs.                                               | _files.log, ocsp.log, pe.log, x509.log._                                                                                                                                                                                                                                                                                           |
| NetControl           | Network control and flow logs.                                           | _netcontrol.log, netcontrol_drop.log, netcontrol_shunt.log, netcontrol_catch_release.log, openflow.log._                                                                                                                                                                                                                           |
| Detection            | Detection and possible indicator logs.                                   | _intel.log, notice.log, notice_alarm.log, signatures.log, traceroute.log._                                                                                                                                                                                                                                                         |
| Network Observations | Network flow logs.                                                       | _known_certs.log, known_hosts.log, known_modbus.log, known_services.log, software.log._                                                                                                                                                                                                                                            |
| Miscellaneous        | Additional logs cover external alerts, inputs and failures.              | _barnyard2.log, dpd.log, unified2.log, unknown_protocols.log, weird.log, weird_stats.log._                                                                                                                                                                                                                                         |
| Zeek Diagnostic      | Zeek diagnostic logs cover system messages, actions and some statistics. | _broker.log, capture_loss.log, cluster.log, config.log, loaded_scripts.log, packet_filter.log, print.log, prof.log, reporter.log, stats.log, stderr.log, stdout.log._                                                                                                                                                              |
|                      |                                                                          |                                                                                                                                                                                                                                                                                                                                    |
| **Update Frequency** | **Log Name  <br>**                                                       | **Description**                                                                                                                                                                                                                                                                                                                    |
| **Daily**            | _known_hosts.log_                                                        | List of hosts that completed TCP handshakes.                                                                                                                                                                                                                                                                                       |
| **Daily**            | _known_services.log_                                                     | List of services used by hosts.                                                                                                                                                                                                                                                                                                    |
| **Daily**            | _known_certs.log_                                                        | List of SSL certificates.                                                                                                                                                                                                                                                                                                          |
| **Daily**            | _software.log_                                                           | List of software used on the network.                                                                                                                                                                                                                                                                                              |
| **Per Session**      | _notice.log_                                                             | Anomalies detected by Zeek.                                                                                                                                                                                                                                                                                                        |
| **Per Session**      | _intel.log_                                                              | Traffic contains malicious patterns/indicators.                                                                                                                                                                                                                                                                                    |
| Per Session          | _signatures.log_                                                         | List of triggered signatures.                                                                                                                                                                                                                                                                                                      |

## Brief log usage primer table


| **Overall Info**     | **Protocol Based** | **Detection**    | **Observation**      |
| -------------------- | ------------------ | ---------------- | -------------------- |
| _conn.log_           | _http.log_         | _notice.log_     | _known_host.log_     |
| _files.log_          | _dns.log_          | _signatures.log_ | _known_services.log_ |
| _intel.log_          | _ftp.log_          | _pe.log_         | _software.log_       |
| _loaded_scripts.log_ | _ssh.log_          | _traceroute.log_ | _weird.log_          |

  

The table shows us how to use multiple logs to identify anomalies and run an investigation by correlating across the available logs.
- **Overall Info:** The aim is to review the overall connections, shared files, loaded scripts and indicators at once. This is the first step of the investigation.
- **Protocol Based:** Once you review the overall traffic and find suspicious indicators or want to conduct a more in-depth investigation, you focus on a specific protocol.
- **Detection:** Use the prebuild or custom scripts and signature outcomes to support your findings by having additional indicators or linked actions. 
- **Observation:** The summary of the hosts, services, software, and unexpected activity statistics will help you discover possible missing points and conclude the investigation.

![[93f31d7853edd50e43be99dd791325e7.png]]

|              |                                      |
| ------------ | ------------------------------------ |
| **Zeek-cut** | Cut specific columns from zeek logs. |
![[Pasted image 20250803195533.png]]



## Answer the questions below

2. Investigate the **sample.pcap** file. Investigate the **dhcp.log** file. What is the available hostname?
cmd to use
```shell
zeek -C -r sample.pcap
```
![[Pasted image 20250803222316.png]]


3. Investigate the **dns**.log file. What is the number of unique DNS queries?
Ans : 2

4. Investigate the **conn.log** file. What is the longest connection duration?
```shell
cat conn.log | zeek-cut uid duration
```
![[Pasted image 20250803223839.png]]

Ans : 332.319364




# CLI Kung-Fu Recall: Processing Zeek Logs

| Category                | Command Purpose and Usage                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | Category      | Command Purpose and Usage                                                                                                                                                                                                                                                                                                                       |
| ----------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Basics                  | View the command history:  <br>`ubuntu@ubuntu$ history`  <br><br>Execute the 10th command in history:  <br>`ubuntu@ubuntu$ !10`<br><br>Execute the previous command:  <br>`ubuntu@ubuntu$ !!`                                                                                                                                                                                                                                                                                                                                                                                                                                   | Read **File** | Read sample.txt file:  <br>`ubuntu@ubuntu$ cat sample.txt`<br><br>Read the first 10 lines of the file:  <br>`ubuntu@ubuntu$ head sample.txt`  <br><br>Read the last 10 lines of the file:  <br>`ubuntu@ubuntu$ tail sample.txt`                                                                                                                 |
| Find  <br>&  <br>Filter | Cut the 1st field:  <br>`ubuntu@ubuntu$ cat test.txt \| cut -f 1`  <br><br>Cut the 1st column:  <br>`ubuntu@ubuntu$ cat test.txt \| cut -c1`  <br><br>Filter specific keywords:  <br>`ubuntu@ubuntu$ cat test.txt \| grep 'keywords'`  <br><br>Sort outputs alphabetically:  <br>`ubuntu@ubuntu$ cat test.txt \| sort`<br><br>Sort outputs numerically:  <br>`ubuntu@ubuntu$ cat test.txt \| sort -n`<br><br>Eliminate duplicate lines:  <br>`ubuntu@ubuntu$ cat test.txt \| uniq`  <br><br>Count line numbers:  <br>`ubuntu@ubuntu$ cat test.txt \| wc -l`  <br><br>Show line numbers  <br>`ubuntu@ubuntu$ cat test.txt \| nl` | Advanced      | Print line 11:  <br>`ubuntu@ubuntu$ cat test.txt \| sed -n '11p'`  <br><br>Print lines between 10-15:  <br>`ubuntu@ubuntu$ cat test.txt \| sed -n '10,15p'`<br><br>Print lines below 11:  <br>`ubuntu@ubuntu$ cat test.txt \| awk 'NR < 11 {print $0}'`  <br><br>Print line 11:  <br>`ubuntu@ubuntu$ cat test.txt \| awk 'NR == 11 {print $0}'` |

|   |   |
|---|---|
|**Special**|Filter specific fields of Zeek logs:<br><br>`ubuntu@ubuntu$ cat signatures.log \| zeek-cut uid src_addr dst_addr`|

|                                                  |                                                                                                  |
| ------------------------------------------------ | ------------------------------------------------------------------------------------------------ |
| **Use Case**                                     | **Description**                                                                                  |
| `sort \| uniq`                                   | Remove duplicate values.                                                                         |
| `sort \| uniq -c`                                | Remove duplicates and count the number of occurrences for each value.                            |
| `sort -nr`                                       | Sort values numerically and recursively.                                                         |
| `rev`                                            | Reverse string characters.                                                                       |
| `cut -f 1`                                       | Cut field 1.                                                                                     |
| `cut -d '.' -f 1-2`                              | Split the string on every dot and print keep the first two fields.                               |
| `grep -v 'test'`                                 | Display lines that  don't match the "test" string.                                               |
| `grep -v -e 'test1' -e 'test2'`                  | Display lines that don't match one or both "test1" and "test2" strings.                          |
| `file`                                           | View file information.                                                                           |
| `grep -rin Testvalue1 * \| column -t \| less -S` | Search the "Testvalue1" string everywhere, organise column spaces and view the output with less. |